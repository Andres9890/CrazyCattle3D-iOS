name: Build iOS 6 Compatible IPA

on:
  workflow_dispatch:
    inputs:
      ios_version:
        description: 'iOS version to target'
        required: true
        default: '6.0'
        type: string

jobs:
  build-ios6:
    name: Build iOS 6 Compatible IPA
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '14.1.0'

      - name: Fix Project Format
        run: |
          sed -i '' 's/objectVersion = 77/objectVersion = 56/' xc/CrazyCattle3D.xcodeproj/project.pbxproj
          sed -i '' 's/preferredProjectObjectVersion = 77/preferredProjectObjectVersion = 56/' xc/CrazyCattle3D.xcodeproj/project.pbxproj

      - name: List Available SDKs
        run: xcodebuild -showsdks

      - name: Modify Xcode Project for iOS 6
        run: |
          # Create a plutil command to directly modify project.pbxproj
          plutil -insert 'objects.PROJECTUUID.attributes.TargetAttributes.TARGETUUID.IPHONEOS_DEPLOYMENT_TARGET' -string "${{ github.event.inputs.ios_version }}" xc/CrazyCattle3D.xcodeproj/project.pbxproj || true
          # Also try to directly modify all deployment target settings in pbxproj file
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*;/IPHONEOS_DEPLOYMENT_TARGET = ${{ github.event.inputs.ios_version }};/g' xc/CrazyCattle3D.xcodeproj/project.pbxproj

      - name: Archive Build (Unsigned) with iOS 6 Target
        run: |
          xcodebuild clean archive \
            -project xc/CrazyCattle3D.xcodeproj \
            -scheme "CrazyCattle3D" \
            -configuration Release \
            -archivePath build/CrazyCattle3D.xcarchive \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_OPTIMIZATION_LEVEL="-Onone" \
            IPHONEOS_DEPLOYMENT_TARGET=${{ github.event.inputs.ios_version }} \
            ARCHS="armv7 armv7s arm64" \
            VALID_ARCHS="armv7 armv7s arm64" \
            OTHER_CFLAGS="-miphoneos-version-min=${{ github.event.inputs.ios_version }}" \
            OTHER_LDFLAGS="-miphoneos-version-min=${{ github.event.inputs.ios_version }}" \
            GCC_PREPROCESSOR_DEFINITIONS="$GCC_PREPROCESSOR_DEFINITIONS TARGET_OS_IPHONE_MIN_VERSION=${{ github.event.inputs.ios_version }}" || exit_code=$?
          
          # If the build failed with the iOS 6 target, try with the minimum supported
          if [ ! -z "$exit_code" ]; then
            echo "Building with iOS 6 target failed, trying with minimum supported iOS version"
            xcodebuild clean archive \
              -project xc/CrazyCattle3D.xcodeproj \
              -scheme "CrazyCattle3D" \
              -configuration Release \
              -archivePath build/CrazyCattle3D.xcarchive \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              ONLY_ACTIVE_ARCH=NO \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              SWIFT_OPTIMIZATION_LEVEL="-Onone" \
              IPHONEOS_DEPLOYMENT_TARGET=9.0 \
              GCC_PREPROCESSOR_DEFINITIONS="$GCC_PREPROCESSOR_DEFINITIONS TARGET_OS_IPHONE_MIN_VERSION=${{ github.event.inputs.ios_version }}"
          fi

      - name: Create IPA from Archive
        run: |
          cp -R build/CrazyCattle3D.xcarchive/Products/Applications/CrazyCattle3D.app .
          mkdir -p Payload
          cp -R CrazyCattle3D.app Payload/
          zip -r CrazyCattle3D-iOS6.ipa Payload
          rm -rf Payload CrazyCattle3D.app

      - name: Upload iOS 6 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CrazyCattle3D-iOS6.ipa
          path: CrazyCattle3D-iOS6.ipa
          retention-days: 90
